<!DOCTYPE html>
<html lang="en">
  <%- include('../partials/adminpanelheader') %>
  <link rel="stylesheet" href="/css/userdetails.css">
  <link rel="stylesheet" href="/css/admindash.css">
  
  <body>
    <!-- Main Content Section -->
    <div class="main-content">
      <!-- Include the top navigation bar -->
      <%- include('../partials/adminnavbar') %>
  
      <div class="container">
        <h1>User Management</h1>
  
        <!-- Search Bar -->
        <div class="search-container">
          <input type="text" id="search-bar" placeholder="Search users..." onkeyup="filterTable()">
        </div>
  
        <!-- Table -->
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Email</th>
              <th>Mobile</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="user-table-body">
            <% users.forEach(user => { %>
              <tr data-user-id="<%= user._id %>">
                <td><%= user.fullName %></td>
                <td><%= user.email %></td>
                <td><%= user.mobile %></td>
                <td class="<%= user.isBlocked ? 'status-blocked' : 'status-active' %>">
                  <%= user.isBlocked ? 'Blocked' : 'Active' %>
                </td>
                <td>
                  <button class="block-unblock-btn <%= user.isBlocked ? 'unblock' : 'block' %>">
                    <%= user.isBlocked ? 'Unblock' : 'Block' %>
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  
    <script>
      document.querySelectorAll('.block-unblock-btn').forEach(button => {
        button.addEventListener('click', async (event) => {
          const btn = event.target;
          const row = btn.closest('tr');
          const userId = row.getAttribute('data-user-id');
          const isBlocked = btn.classList.contains('unblock');
  
          try {
            const response = await fetch(`/admin/users/${isBlocked ? 'unblock' : 'block'}/${userId}`, {
              method: 'POST'
            });
  
            if (response.ok) {
              // Toggle the button text and styles
              if (isBlocked) {
                btn.textContent = 'Block';
                btn.classList.remove('unblock');
                btn.classList.add('block');
                row.querySelector('td:nth-child(4)').textContent = 'Active';
                row.querySelector('td:nth-child(4)').classList.remove('status-blocked');
                row.querySelector('td:nth-child(4)').classList.add('status-active');
              } else {
                btn.textContent = 'Unblock';
                btn.classList.remove('block');
                btn.classList.add('unblock');
                row.querySelector('td:nth-child(4)').textContent = 'Blocked';
                row.querySelector('td:nth-child(4)').classList.remove('status-active');
                row.querySelector('td:nth-child(4)').classList.add('status-blocked');
              }
            } else {
              // Log the error silently
              console.error('Failed to update user status.');
            }
          } catch (error) {
            console.error(error); // Log the error instead of showing an alert
          }
        });
      });
  
      function filterTable() {
        const searchQuery = document.getElementById("search-bar").value.toLowerCase();
        const rows = document.querySelectorAll("#user-table-body tr");
  
        rows.forEach(row => {
          const nameCell = row.querySelector("td:first-child").textContent.toLowerCase();
          const emailCell = row.querySelector("td:nth-child(2)").textContent.toLowerCase();
  
          if (nameCell.includes(searchQuery) || emailCell.includes(searchQuery)) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }
    </script>
  </body>
</html>
